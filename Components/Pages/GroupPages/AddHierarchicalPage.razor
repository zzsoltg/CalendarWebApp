@using CalendarWebApp.Data
@using CalendarWebApp.Utility
@using MyGroup = CalendarWebApp.Data.Group
@using CalendarWebApp.Repository.IRepository
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Radzen
@using Radzen.Blazor

@inject IGroupRepository GroupRepository
@inject IOrganisationRepository OrganisationRepository
@inject UserManager<ApplicationUser> UserManager
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject ApplicationDbContext DbContext

<RadzenTemplateForm TItem="HierarchicalGroupDto" Data="@model" Submit=@OnSubmit>
    <RadzenStack Gap="1rem">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
            <RadzenLabel Text="Szervezet" Style="width: 8rem;" />
            <RadzenDropDown Name="Organisation"
                            Data="@organisations"
                            @bind-Value="model.OrganisationId"
                            TextProperty="Name"
                            ValueProperty="Id"
                            Placeholder="(nincs)"
                            Style="width: 18rem;" />
            <RadzenRequiredValidator Component="Organisation" Text="A szervezet kiválasztása kötelező!" Popup="true" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
            <RadzenLabel Text="Csoportnév" Style="width: 8rem;" />
            <RadzenTextBox Name="GroupName" @bind-Value="model.GroupName" Style="width: 18rem;" />
            <RadzenRequiredValidator Component="GroupName" Text="A csoport neve kötelező!" Popup="true" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
            <RadzenLabel Text="Csoportvezető" Style="width: 8rem;" />
            <RadzenDropDown Name="GroupLeader"
                            Data="@groupLeaders"
                            @bind-Value="model.GroupLeaderId"
                            Change="@OnLeaderChanged"
                            TextProperty="Name"
                            ValueProperty="Id"
                            AllowClear="true"
                            AllowFiltering="true"
                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                            Placeholder="(nincs)"
                            Style="width: 18rem;" />
            <RadzenRequiredValidator Component="GroupLeader" Text="Csoportvezető választása kötelező!" Popup="true" Style="position: absolute" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Stretch" Wrap="FlexWrap.Wrap">
            <RadzenLabel Text="Tagok" Style="width: 8rem;" />

            <RadzenDropDown Name="Members"
                            Data="@allUsers"
                            @bind-Value="model.SelectedUserIds"
                            Change="@OnMembersChanged"
                            TextProperty="Name"
                            ValueProperty="Id"
                            Multiple="true"
                            AllowClear="true"
                            AllowFiltering="true"
                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                            Placeholder="Nincs tag kiválasztva"
                            Style="width: 18rem; height: 300px;"
                            Chips="true"
                            MaxSelectedLabels="1000" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Class="rz-mt-2">
            <RadzenButton ButtonType="ButtonType.Submit" Text="Mentés" IsBusy="@isSaving" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    private HierarchicalGroupDto model = new();
    private List<Organisation> organisations = new();
    private List<ApplicationUser> allUsers = new();
    private List<ApplicationUser> groupLeaders = new();
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        organisations = await OrganisationRepository.GetAllAsync();
        allUsers = await UserManager.Users.OrderBy(u => u.Name).ToListAsync();
        var allGroups = await GroupRepository.GetAllHierarchicalAsync();
        var busyLeaderIds = allGroups
            .Where(g => g.GroupLeaderId != null)
            .Select(g => g.GroupLeaderId)
            .ToHashSet();
        var leaders = await UserManager.GetUsersInRoleAsync(SD.Role_Group_Leader);
        var gods = await UserManager.GetUsersInRoleAsync(SD.Role_God);
        groupLeaders = leaders
            .Concat(gods)
            .DistinctBy(u => u.Id)
            .Where(u => !busyLeaderIds.Contains(u.Id))
            .OrderBy(u => u.Name)
            .ToList();
    }

    private void OnLeaderChanged(object value)
    {
        var newLeaderId = (string)value;

        if (string.IsNullOrEmpty(newLeaderId)) return;

        var currentMembers = (model.SelectedUserIds ?? new List<string>()).ToList();

        if (!currentMembers.Contains(newLeaderId))
        {
            currentMembers.Add(newLeaderId);
            model.SelectedUserIds = currentMembers;
        }
    }

    private async Task OnMembersChanged(object value)
    {
        if (string.IsNullOrEmpty(model.GroupLeaderId)) return;

        var selectedMembers = (IEnumerable<string>)value;

        if (selectedMembers == null || !selectedMembers.Contains(model.GroupLeaderId))
        {
            await DialogService.Alert("A csoportvezető automatikusan tagja a csoportnak, ezért nem távolítható el a listából.", "Figyelmeztetés",
                new AlertOptions()
                {
                    OkButtonText = "Rendben",
                    CssClass = "glass-dialog",
                    Width = "400px"
                });

            var fixedList = (selectedMembers ?? Enumerable.Empty<string>()).ToList();
            fixedList.Add(model.GroupLeaderId);
            model.SelectedUserIds = fixedList;
        }
    }


    private async Task OnSubmit()
    {
        isSaving = true;
        try
        {
            var newGroup = new MyGroup
            {
                Name = model.GroupName,
                OrganisationId = model.OrganisationId,
                GroupLeaderId = model.GroupLeaderId
            };

            await GroupRepository.CreateAsync(newGroup);

            if (model.SelectedUserIds != null && model.SelectedUserIds.Any())
            {
                foreach (var userId in model.SelectedUserIds)
                {
                    await DbContext.Database.ExecuteSqlRawAsync(
                        "UPDATE AspNetUsers SET HierarchicalGroupId = {0} WHERE Id = {1}",
                        newGroup.Id,
                        userId
                    );
                }
            }
            DialogService.Close(true);
            DialogService.Alert("A hierarchikus csoport sikeresen létrejött.", "Sikeres mentés", new AlertOptions() { OkButtonText = "OK", CssClass = "glass-dialog", Width = "600px" });
        }
        catch (Exception ex)
        {
            DialogService.Alert($"Hiba történt a művelet során: {ex.Message}", "Hiba", new AlertOptions() { OkButtonText = "OK", CssClass = "glass-dialog", Width = "600px" });
        }
        finally
        {
            isSaving = false;
        }
    }

    public class HierarchicalGroupDto
    {
        public int OrganisationId { get; set; }
        public string GroupName { get; set; } = "";
        public string? GroupLeaderId { get; set; }
        public IEnumerable<string> SelectedUserIds { get; set; } = new List<string>();
    }
}