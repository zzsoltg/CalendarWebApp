@page "/calendar"

@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

@using CalendarWebApp.Repository.IRepository
@using MyAppointment = RadzenBlazorDemos.Appointment

@inject DialogService DialogService
@inject IAppointmentRepository _appointmentRepository
@inject Radzen.TooltipService TooltipService

@if (IsProcessing)
{
    <div class="position-absolute w-75 h-75 d-flex flex-column align-items-center bg-white justify-content-center">
        <img src="/img/loading.gif" alt="loading" />
    </div>
}
else
{
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" class="rz-p-4 rz-mb-6 rz-border-radius-1" Style="border: var(--rz-grid-cell-border);height:4rem;">
        <RadzenLabel Text="Show Header:  " />
        <RadzenSwitch @bind-Value=@showHeader />
    </RadzenStack>

    <RadzenScheduler @ref=@scheduler SlotRender=@OnSlotRender style="height: 768px;" TItem="MyAppointment" Data=@appointments StartProperty="Start" EndProperty="End" ShowHeader=@showHeader
                     TextProperty="Text" SelectedIndex="2" AppointmentMouseEnter=@OnAppointmentMouseEnter AppointmentMouseLeave=@OnAppointmentMouseLeave
                     SlotSelect=@OnSlotSelect AppointmentSelect=@OnAppointmentSelect AppointmentRender=@OnAppointmentRender DaySelect="@OnDaySelect"
                     AppointmentMove=@OnAppointmentMove>
        <RadzenDayView />
        <RadzenWeekView />
        <RadzenMonthView />
    </RadzenScheduler>

    @* <EventConsole @ref=@console /> *@   
}

@code {
    RadzenScheduler<MyAppointment> scheduler;
    // EventConsole console;
    Dictionary<DateTime, string> events = new Dictionary<DateTime, string>();
    private bool IsProcessing { get; set; } = true;

    bool showHeader = true;

    IEnumerable<MyAppointment> appointments = new List<MyAppointment>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAppointments();
            IsProcessing = false;
            StateHasChanged();
        }
    }

    private async Task LoadAppointments()
    {
        appointments = await _appointmentRepository.GetAllAsync();
    }

    void OnDaySelect(SchedulerDaySelectEventArgs args)
    {
        // console.Log($"DaySelect: Day={args.Day} AppointmentCount={args.Appointments.Count()}");
    }

    void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        // Highlight today in month view
        if (args.View.Text == "Month" && args.Start.Date == DateTime.Today)
        {
            args.Attributes["style"] = "background: var(--rz-scheduler-highlight-background-color, rgba(255,220,40,.2));";
        }

        // Highlight working hours (9-18)
        if ((args.View.Text == "Week" || args.View.Text == "Day") && args.Start.Hour > 8 && args.Start.Hour < 19)
        {
            args.Attributes["style"] = "background: var(--rz-scheduler-highlight-background-color, rgba(255,220,40,.2));";
        }
    }

    async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        // console.Log($"SlotSelect: Start={args.Start} End={args.End}");

        if (args.View.Text != "Year")
        {
            MyAppointment data = await DialogService.OpenAsync<AddAppointmentPage>("Add Appointment",
                new Dictionary<string, object> { { "Start", args.Start }, { "End", args.End } });

            if (data != null)
            {
                await _appointmentRepository.CreateAsync(data);
                await LoadAppointments();
                // Either call the Reload method or reassign the Data property of the Scheduler
                await scheduler.Reload();
            }
        }
    }

    async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<MyAppointment> args)
    {
        // console.Log($"AppointmentSelect: Appointment={args.Data.Text}");

        var copy = new MyAppointment
        {
            Id = args.Data.Id,
            Start = args.Data.Start,
            End = args.Data.End,
            Text = args.Data.Text,
            Type = args.Data.Type
        };

        var data = await DialogService.OpenAsync<EditAppointmentPage>("Edit Appointment", new Dictionary<string, object> { { "Appointment", copy } });

        if (data is MyAppointment model)
        {
            await _appointmentRepository.UpdateAsync(data);

            await LoadAppointments();
            await scheduler.Reload();
        }
        else if (data is bool deleted && deleted)
        {
            await LoadAppointments();
            await scheduler.Reload();
        }
    }

    void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<MyAppointment> args)
    {
        // Never call StateHasChanged in AppointmentRender - would lead to infinite loop

        switch (args.Data.Type)
        {
            case "Szabadság":
                args.Attributes["style"] = "background: green";
                break;
            case "HomeOffice":
                args.Attributes["style"] = "background: blue";
                break;
            case "Képzés":
                args.Attributes["style"] = "background: red";
                break;
        }

    }

    async Task OnAppointmentMove(SchedulerAppointmentMoveEventArgs args)
    {
        var draggedAppointment = appointments.FirstOrDefault(x => x == args.Appointment.Data);

        if (draggedAppointment != null)
        {
            var duration = draggedAppointment.End - draggedAppointment.Start;

            if (args.SlotDate.TimeOfDay == TimeSpan.Zero)
            {
                draggedAppointment.Start = args.SlotDate.Date.Add(draggedAppointment.Start.TimeOfDay);
            }
            else
            {
                draggedAppointment.Start = args.SlotDate;
            }

            draggedAppointment.End = draggedAppointment.Start.Add(duration);

            await scheduler.Reload();
        }
    }

    void OnAppointmentMouseEnter(SchedulerAppointmentMouseEventArgs<Appointment> args)
    {
        static bool IsSingleDay(Appointment a)
        {
            var startDate = a.Start.Date;
            var effectiveEndDate = a.End.TimeOfDay == TimeSpan.Zero ? a.End.Date.AddDays(-1) : a.End.Date;
            return startDate == effectiveEndDate;
        }

        bool onlySunday = IsSingleDay(args.Data) && args.Data.Start.DayOfWeek == DayOfWeek.Sunday;
        var position = onlySunday ? TooltipPosition.Left : TooltipPosition.Top;

        TooltipService.Open(args.Element, ts =>
        @<RadzenStack Orientation="Orientation.Vertical" Gap="0" class="rz-p-6" Style="min-width: 250px; max-width: 500px;">
            <RadzenText TextStyle="TextStyle.H4" class="rz-mb-4" Style="color: var(--rz-tooltip-color);">
                @args.Data.Text
            </RadzenText>
            @if (args.Data.Type != null)
            {
                <RadzenText TextStyle="TextStyle.Caption" class="rz-mb-4" Style="color: var(--rz-tooltip-color);">
                    Type: @args.Data.Type
                </RadzenText>
            }
            <RadzenStack Orientation="Orientation.Horizontal" Gap="4px">
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color); width: 44px;">
                    <strong>Start</strong>
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color);">
                    @args.Data.Start.ToString("hh:mm ⋅ dddd, MMMM d")
                </RadzenText>
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="4px">
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color); width: 44px;">
                    <strong>End</strong>
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color);">
                    @args.Data.End.ToString("hh:mm ⋅ dddd, MMMM d")
                </RadzenText>
            </RadzenStack>
        </RadzenStack>, new TooltipOptions { Position = position, Duration = null });
    }

    void OnAppointmentMouseLeave(SchedulerAppointmentMouseEventArgs<Appointment> args)
    {
        TooltipService.Close();
    }
}