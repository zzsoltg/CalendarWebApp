@page "/sharedcalendar"

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Radzen
@using Microsoft.EntityFrameworkCore
@using CalendarWebApp.Repository.IRepository
@using MyAppointment = RadzenBlazorDemos.Appointment
@using CalendarWebApp.Data
@attribute [Authorize]

@inject DialogService DialogService
@inject IAppointmentRepository _appointmentRepository
@inject Radzen.TooltipService TooltipService
@inject AuthenticationStateProvider _AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager


<RadzenCard Variant="Variant.Outlined" class="rz-my-4">
    <RadzenStack Orientation="Orientation.Horizontal" Gap="2rem" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
            <RadzenCheckBox @bind-Value=@allowRowSelectOnRowClick Name="CheckBox1" />
            <RadzenLabel Text="Allow row select on row click" Component="CheckBox1" />
        </RadzenStack>
        <RadzenButton Text="Clear selected rows" Click="@(async args => { selectedEmployees = null; await LoadAppointments(); })" />
    </RadzenStack>
</RadzenCard>

<RadzenDataGrid @ref="grid" AllowRowSelectOnRowClick="true" AllowFiltering="true" FilterPopupRenderMode="PopupRenderMode.OnDemand" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowPaging="true" PageSize="4"
                AllowSorting="true" Data="@employees" ColumnWidth="200px"
                SelectionMode="DataGridSelectionMode.Multiple"
                Value="@selectedEmployees"
                ValueChanged="@(async (IList<ApplicationUser> args) => { selectedEmployees = args; await LoadAppointments(); })">
    <Columns>
        <RadzenDataGridColumn Width="60px" Sortable="false" Filterable="false">
            <HeaderTemplate>
                <RadzenCheckBox TabIndex="-1" TriState="false" TValue="bool?" InputAttributes="@(new Dictionary<string, object>() { { "aria-label", "Select all items" } })"
                                Value="@(selectedEmployees == null || selectedEmployees?.Any() != true ? false : !employees.All(i => selectedEmployees.Contains(i)) ? null : employees.Any(i => selectedEmployees.Contains(i)))"
                                Change="@(async args => {
                                    selectedEmployees = args == true ? employees.ToList() : null;
                                    await LoadAppointments();
                                })" />
            </HeaderTemplate>
            <Template Context="data">
                <RadzenCheckBox TabIndex="-1" TriState="false" Value="@(selectedEmployees != null && selectedEmployees.Contains(data))" InputAttributes="@(new Dictionary<string, object>() { { "aria-label", "Select item" } })"
                                TValue="bool" Change=@(args => { if (!allowRowSelectOnRowClick) { grid.SelectRow(data); } }) />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.Name)" Title="Name" />
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.UserName)" Title="Email" />
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.PhoneNumber)" Title="Phone number" />
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.DateOfBirth)" Title="Date of birth" FormatString="{0:d}" />
    </Columns>
</RadzenDataGrid>


@if (isProcessing)
{
    <div class="position-absolute w-75 h-75 d-flex flex-column align-items-center bg-white justify-content-center">
        <img src="/img/loading.gif" alt="loading" />
    </div>
}
else
{
    <RadzenCard Variant="Variant.Outlined" class="rz-my-4" style="background-color: whitesmoke">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" class="rz-mb-4">
            <RadzenLabel Text="Hónap:" Style="font-weight: bold;" />
            <RadzenDatePicker @bind-Value="@viewDate" DateFormat="yyyy MMMM" Change="@OnViewDateChanged" ShowTime="false" />
            <RadzenText TextStyle="TextStyle.Caption">Válassz hónapot a táblázat frissítéséhez</RadzenText>
        </RadzenStack>

        @if (selectedEmployees != null && selectedEmployees.Any())
        {
            <div class="matrix-scroll-container">
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th class="sticky-col">Név</th>
                            @for (int day = 1; day <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); day++)
                            {
                                var currentDayDate = new DateTime(viewDate.Year, viewDate.Month, day);
                                <th class="@(IsWeekend(currentDayDate) ? "weekend-header" : "")">
                                    @day <br />
                                    <small>@currentDayDate.ToString("ddd")</small>
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var emp in selectedEmployees)
                        {
                            <tr>
                                <td class="sticky-col">@emp.Name</td>
                                @for (int day = 1; day <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); day++)
                                {
                                    var dateToCheck = new DateTime(viewDate.Year, viewDate.Month, day);
                                    var appointment = GetAppointmentForUserAndDate(emp.Id, dateToCheck);
                                    var bgStyle = GetColorForType(appointment?.Type);

                                    <td class="matrix-cell" style="@bgStyle" title="@(appointment?.Type ?? "")">
                                        @if (appointment != null)
                                        {
                                            <span class="event-indicator">@appointment.Type?.FirstOrDefault()</span>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <RadzenAlert Severity="Severity.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
                Válassz ki legalább egy felhasználót a fenti listából a táblázat megtekintéséhez!
            </RadzenAlert>
        }
    </RadzenCard>
}

@code {
    private RadzenScheduler<MyAppointment> scheduler;
    private Dictionary<DateTime, string> events = new Dictionary<DateTime, string>();
    private bool isProcessing { get; set; } = true;

    private bool allowRowSelectOnRowClick = true;
    private IEnumerable<ApplicationUser> employees;
    private IList<ApplicationUser>? selectedEmployees;
    private RadzenDataGrid<ApplicationUser> grid;
    private DateTime viewDate = DateTime.Today;

    private IEnumerable<MyAppointment> appointments = new List<MyAppointment>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAppointments();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        employees = UserManager.Users.ToList();
    }

    private async Task LoadAppointments()
    {
        isProcessing = true;
        if (selectedEmployees != null && selectedEmployees.Any())
        {
            var selectedUserIds = selectedEmployees.Select(u => u.Id).ToList();
            appointments = await _appointmentRepository.GetByUsersAsync(selectedUserIds);
        }
        else
        {
            appointments = new List<MyAppointment>();
        }

        if (scheduler != null)
        {
            await scheduler.Reload();
        }
        isProcessing = false;
        StateHasChanged();
    }

    private void OnViewDateChanged(DateTime? value)
    {
        if (value.HasValue)
        {
            viewDate = value.Value;
            StateHasChanged();
        }
    }

    private bool IsWeekend(DateTime date)
    {
        return date.DayOfWeek == DayOfWeek.Saturday || date.DayOfWeek == DayOfWeek.Sunday;
    }

    private MyAppointment? GetAppointmentForUserAndDate(string userId, DateTime date)
    {
        if (appointments == null)
        {
            return null;
        }
        return appointments.FirstOrDefault(a =>
            (a.UserId == userId) &&
            a.Start.Date <= date.Date &&
            a.End.Date >= date.Date
        );
    }

    private string GetColorForType(string? type)
    {
        if (string.IsNullOrEmpty(type))
        {
            return "";
        }

        return type switch
        {
            "Szabadság" => "background-color: #66BB6A;",
            "HomeOffice" => "background-color: #FFA000;",
            "Képzés" => "background-color: #EF5350;",
            "Táppénz" => "background-color: #90A4AE;"
        };
    }
}