@page "/sharedcalendar"

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Radzen
@using System.Collections
@using Microsoft.EntityFrameworkCore
@using CalendarWebApp.Repository.IRepository
@using MyAppointment = RadzenBlazorDemos.Appointment
@using CalendarWebApp.Data
@attribute [Authorize]

@inject IAppointmentRepository _appointmentRepository
@inject UserManager<ApplicationUser> UserManager


<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="0.5rem" class="rz-p-sm-12">
    <RadzenLabel Text="Szűrés csoportra" Component="DropDownGroupingMultiSelect" Style="margin-right: 8px; vertical-align: middle;" />

    <RadzenDropDown @ref=dd @bind-Value=@values TValue="IEnumerable<string>" AllowClear="true" Name="DropDownGroupingMultiSelect" Change="@(args => FilterEmployees())"
                    Data=@groupedData Style="width: 100%; max-width: 400px;" ItemRender="ItemRender">
        <HeaderTemplate>
            <RadzenStack Orientation="Orientation.Horizontal" class="rz-multiselect-header rz-dropdown-filter-container rz-helper-clearfix">
                <RadzenCheckBox TValue="bool?" TriState=false Value="@AreAllSelected()" Change="@SelectAll" title="@(dd.SelectAllText)" Disabled=@(!groupedData.Any()) />
                <input id="@($"{dd.SearchID}")" @oninput=@Search placeholder="Keresés..." class="rz-inputtext" role="textbox" type="text"
                       aria-label="@(dd.SearchAriaLabel)" style="margin-inline-start:0.5rem;width:100%;border:0;background:transparent;" />
            </RadzenStack>
        </HeaderTemplate>
        <Template>
            <RadzenCheckBox TValue="bool?" TriState=false Value="@IsGroupSelected(context)" Change="@(args => SelectGroup(args, (GroupItem)context))" />

            <RadzenLabel Style=@($"margin-inline-start: 0.5rem; font-weight: {(context.Organization != null ? "bold" : "normal")}")
                         Text="@(context.Organization ?? context.GroupName)"
                         onclick="event.target.previousElementSibling.querySelector('.rz-chkbox-box').click()" />
        </Template>
        <ValueTemplate>
            @string.Join(", ", values ?? Enumerable.Empty<string>())
        </ValueTemplate>
    </RadzenDropDown>
</RadzenStack>

<RadzenDataGrid @ref="grid" AllowRowSelectOnRowClick="true" AllowFiltering="true" FilterPopupRenderMode="PopupRenderMode.OnDemand" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowPaging="true" PageSize="4"
                AllowSorting="true" Data="@employees" ColumnWidth="200px"
                SelectionMode="DataGridSelectionMode.Multiple"
                Value="@selectedEmployees"
                ValueChanged="@(async (IList<ApplicationUser> args) => { selectedEmployees = args; await LoadAppointments(); })">
    <Columns>
        <RadzenDataGridColumn Width="60px" Sortable="false" Filterable="false">
            <HeaderTemplate>
                <RadzenCheckBox TabIndex="-1" TriState="false" TValue="bool?" InputAttributes="@(new Dictionary<string, object>() { { "aria-label", "Select all items" } })"
                                Value="@(selectedEmployees == null || selectedEmployees?.Any() != true ? false : !employees.All(i => selectedEmployees.Contains(i)) ? null : employees.Any(i => selectedEmployees.Contains(i)))"
                                Change="@(async args => {
                                    selectedEmployees = args == true ? employees.ToList() : null;
                                    await LoadAppointments();
                                })" />
            </HeaderTemplate>
            <Template Context="data">
                <RadzenCheckBox TabIndex="-1" TriState="false" Value="@(selectedEmployees != null && selectedEmployees.Contains(data))" InputAttributes="@(new Dictionary<string, object>() { { "aria-label", "Select item" } })"
                                TValue="bool" Change=@(args => { if (!allowRowSelectOnRowClick) { grid.SelectRow(data); } }) />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.Name)" Title="Name" />
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.UserName)" Title="Email" />
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.PhoneNumber)" Title="Phone number" />
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.DateOfBirth)" Title="Date of birth" FormatString="{0:d}" />
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.Organisation)" Title="Organisation" />
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.Group)" Title="Group" />
    </Columns>
</RadzenDataGrid>


@if (isProcessing)
{
    <div class="position-absolute w-75 h-75 d-flex flex-column align-items-center bg-white justify-content-center">
        <img src="/img/loading.gif" alt="loading" />
    </div>
}
else
{
    <RadzenCard Variant="Variant.Outlined" class="rz-my-4" style="background-color: whitesmoke">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" class="rz-mb-4">
            <RadzenLabel Text="Hónap:" Style="font-weight: bold;" />
            <RadzenDatePicker @bind-Value="@viewDate" DateFormat="yyyy MMMM" Change="@OnViewDateChanged" ShowTime="false" />
            <RadzenText TextStyle="TextStyle.Caption">Válassz hónapot a táblázat frissítéséhez</RadzenText>
        </RadzenStack>

        @if (selectedEmployees != null && selectedEmployees.Any())
        {
            <div class="matrix-scroll-container">
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th class="sticky-col">Név</th>
                            @for (int day = 1; day <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); day++)
                            {
                                var currentDayDate = new DateTime(viewDate.Year, viewDate.Month, day);
                                <th class="@(IsWeekend(currentDayDate) ? "weekend-header" : "")">
                                    @day <br />
                                    <small>@currentDayDate.ToString("ddd")</small>
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var emp in selectedEmployees)
                        {
                            <tr>
                                <td class="sticky-col">@emp.Name</td>
                                @for (int day = 1; day <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); day++)
                                {
                                    var dateToCheck = new DateTime(viewDate.Year, viewDate.Month, day);
                                    var appointment = GetAppointmentForUserAndDate(emp.Id, dateToCheck);
                                    var bgStyle = GetColorForType(appointment?.Type);

                                    <td class="matrix-cell" style="@bgStyle" title="@(appointment?.Type ?? "")">
                                        @if (appointment != null)
                                        {
                                            <span class="event-indicator">@appointment.Type?.FirstOrDefault()</span>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <RadzenAlert Severity="Severity.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
                Válassz ki legalább egy felhasználót a fenti listából a táblázat megtekintéséhez!
            </RadzenAlert>
        }
    </RadzenCard>
}


@code {
    private bool isProcessing { get; set; } = true;

    private bool allowRowSelectOnRowClick = true;
    private IEnumerable<ApplicationUser> employees;
    private IList<ApplicationUser>? selectedEmployees;
    private RadzenDataGrid<ApplicationUser> grid;
    private DateTime viewDate = DateTime.Today;

    private RadzenDropDown<IEnumerable<string>> dd;
    private IEnumerable<string> values;
    private IEnumerable<GroupItem> groupedData = new List<GroupItem>();
    private string search;

    private readonly List<OrganizationDef> organizationDefinitions = new List<OrganizationDef>
    {
        new OrganizationDef
        {
            Name = "Infrastruktúra és szolgáltatások",
            Groups = new List<string> { "Webfejlesztés", "Informatika", "Alaprendszer" }
        },
        new OrganizationDef
        {
            Name = "Forrás-termékfejlesztés",
            Groups = new List<string> { "Egyedi fejlesztések", "Pénzügy" }
        },
        new OrganizationDef
        {
            Name = "Projektigazgatóság",
            Groups = new List<string> { "Logisztika" }
        }
    };

    private class GroupItem
    {
        public string Organization { get; set; }
        public string GroupName { get; set; }
        public IEnumerable<string> Children { get; set; } = Enumerable.Empty<string>();
    }

    private class OrganizationDef
    {
        public string Name { get; set; }
        public IEnumerable<string> Groups { get; set; }
    }

    private IEnumerable<MyAppointment> appointments = new List<MyAppointment>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAppointments();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await Populate();
        FilterEmployees();
    }

    private async Task LoadAppointments()
    {
        isProcessing = true;
        if (selectedEmployees != null && selectedEmployees.Any())
        {
            var selectedUserIds = selectedEmployees.Select(u => u.Id).ToList();
            appointments = await _appointmentRepository.GetByUsersAsync(selectedUserIds);
        }
        else
        {
            appointments = new List<MyAppointment>();
        }
        isProcessing = false;
        StateHasChanged();
    }

    private void OnViewDateChanged(DateTime? value)
    {
        if (value.HasValue)
        {
            viewDate = value.Value;
            StateHasChanged();
        }
    }

    private bool IsWeekend(DateTime date)
    {
        return date.DayOfWeek == DayOfWeek.Saturday || date.DayOfWeek == DayOfWeek.Sunday;
    }

    private MyAppointment? GetAppointmentForUserAndDate(string userId, DateTime date)
    {
        if (appointments == null)
        {
            return null;
        }
        return appointments.FirstOrDefault(a =>
            (a.UserId == userId) &&
            a.Start.Date <= date.Date &&
            a.End.Date >= date.Date
        );
    }

    private string GetColorForType(string? type)
    {
        if (string.IsNullOrEmpty(type))
        {
            return "";
        }

        return type switch
        {
            "Szabadság" => "background-color: #66BB6A;",
            "HomeOffice" => "background-color: #FFA000;",
            "Képzés" => "background-color: #EF5350;",
            "Táppénz" => "background-color: #90A4AE;"
        };
    }

    private void ItemRender(DropDownItemRenderEventArgs<IEnumerable<string>> args)
    {
        args.Disabled = true;
        var item = (GroupItem)args.Item;
        args.Attributes.Add("style", $"opacity:1;{(item.Organization == null ? "margin-inline-start:1rem" : "")}");
    }

    private async Task Populate()
    {
        var filteredDefs = organizationDefinitions.Select(org => new OrganizationDef
        {
            Name = org.Name,
            Groups = string.IsNullOrEmpty(search) ? org.Groups :
                     org.Groups.Where(g => g.ToLower().Contains(search.ToLower()) || org.Name.ToLower().Contains(search.ToLower())).ToList()
        }).Where(org => org.Groups.Any()).ToList();
        
        groupedData = await Task.FromResult(filteredDefs
            .SelectMany(org =>
                new GroupItem[] { new GroupItem { Organization = org.Name, Children = org.Groups } }
                .Concat(org.Groups.Select(g => new GroupItem { GroupName = g }))
            ).ToList());
    }

    private bool? AreAllSelected()
    {
        var allDataItems = groupedData.Where(x => x.Organization == null).ToList();

        if (!allDataItems.Any()) return false;

        var selectedCount = allDataItems.Count(g => values?.Contains(g.GroupName) == true);

        return selectedCount == allDataItems.Count ? true :
               selectedCount > 0 ? null : false;
    }

    private bool? IsGroupSelected(GroupItem item)
    {
        if (item.Organization != null)
        {
            if (!item.Children.Any()) return false;

            var selectedChildren = item.Children.Count(childName => values?.Contains(childName) == true);

            return selectedChildren == item.Children.Count() ? true :
                   selectedChildren > 0 ? null : false;
        }

        return values?.Contains(item.GroupName) == true;
    }

    private void SelectGroup(bool? value, GroupItem item)
    {
        var currentValues = (values ?? Enumerable.Empty<string>()).ToList();

        IEnumerable<string> itemsToToggle;

        if (item.Organization != null)
        {
            itemsToToggle = item.Children;
        }
        else
        {
            itemsToToggle = new[] { item.GroupName };
        }

        if (value == true)
        {
            foreach (var g in itemsToToggle)
            {
                if (!currentValues.Contains(g)) currentValues.Add(g);
            }
        }
        else
        {
            foreach (var g in itemsToToggle)
            {
                currentValues.Remove(g);
            }
        }

        values = currentValues;
        FilterEmployees();
    }

    private void SelectAll(bool? value)
    {
        values = value == true ? groupedData.Where(x => x.Organization == null).Select(x => x.GroupName).ToList() : Enumerable.Empty<string>();
        FilterEmployees();
    }

    private void FilterEmployees()
    {
        if (values == null || !values.Any())
        {
            employees = UserManager.Users.ToList();
        }
        else
        {
            employees = UserManager.Users.Where(u => values.Contains(u.Group)).ToList();
        }

        selectedEmployees = null;
        StateHasChanged();
    }

    private async Task Search(ChangeEventArgs args)
    {
        search = $"{args.Value}";
        await Populate();
    }
}