@page "/sharedcalendar"

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Radzen
@using System.Collections
@using Microsoft.EntityFrameworkCore
@using CalendarWebApp.Repository.IRepository
@using MyAppointment = RadzenBlazorDemos.Appointment
@using CalendarWebApp.Data
@attribute [Authorize]

@inject IAppointmentRepository _appointmentRepository
@inject UserManager<ApplicationUser> UserManager

<div class="liquid-calendar-wrapper rz-p-4">

    <div class="glass-section rz-mb-4">
        <RadzenText TextStyle="TextStyle.H5" class="section-title">Csoportok és Munkatársak</RadzenText>

        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" class="rz-mb-3">
            <RadzenLabel Text="Szűrés csoportra:" Style="font-weight: 600; color: #233D4D;" />

            <RadzenDropDown @ref=dd @bind-Value=@values TValue="IEnumerable<string>" AllowClear="true"
                            Data=@groupedData Style="width: 100%; max-width: 400px;" ItemRender="ItemRender"
                            class="glass-dropdown">
                <HeaderTemplate>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" class="rz-p-2">
                        <RadzenCheckBox TValue="bool?" TriState=false Value="@AreAllSelected()" Change="@SelectAll" title="@(dd.SelectAllText)" Disabled=@(!groupedData.Any()) />
                        <input id="@($"{dd.SearchID}")" @oninput=@Search placeholder="Keresés..." class="glass-search-input" autocomplete="off" />
                    </RadzenStack>
                </HeaderTemplate>
                <Template>
                    <RadzenCheckBox TValue="bool?" TriState=false Value="@IsGroupSelected(context)" Change="@(args => SelectGroup(args, (GroupItem)context))" />
                    <RadzenLabel Style=@($"margin-inline-start: 0.5rem; color: #233D4D; cursor: pointer; font-weight: {(context.Organization != null ? "800" : "500")}")
                                 Text="@(context.Organization ?? context.GroupName)"
                                 onclick="event.target.previousElementSibling.querySelector('.rz-chkbox-box').click()" />
                </Template>
                <ValueTemplate>
                    @string.Join(", ", values ?? Enumerable.Empty<string>())
                </ValueTemplate>
            </RadzenDropDown>
        </RadzenStack>

        <RadzenDataGrid @ref="grid" AllowRowSelectOnRowClick="true" AllowFiltering="true"
                        FilterPopupRenderMode="PopupRenderMode.OnDemand" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        AllowPaging="true" PageSize="5" AllowSorting="true" Data="@employees"
                        SelectionMode="DataGridSelectionMode.Multiple"
                        Value="@selectedEmployees"
                        ValueChanged="@(async (IList<ApplicationUser> args) => { selectedEmployees = args; await LoadAppointments(); })"
                        class="glass-grid">
            <Columns>
                <RadzenDataGridColumn Width="50px" Sortable="false" Filterable="false">
                    <HeaderTemplate>
                        <RadzenCheckBox TabIndex="-1" TriState="false" TValue="bool?"
                                        Value="@(selectedEmployees == null || selectedEmployees?.Any() != true ? false : !employees.All(i => selectedEmployees.Contains(i)) ? null : employees.Any(i => selectedEmployees.Contains(i)))"
                                        Change="@(async args => { selectedEmployees = args == true ? employees.ToList() : null; await LoadAppointments(); })" />
                    </HeaderTemplate>
                    <Template Context="data">
                        <RadzenCheckBox TabIndex="-1" TriState="false" Value="@(selectedEmployees != null && selectedEmployees.Contains(data))"
                                        TValue="bool" Change=@(args => { if (!allowRowSelectOnRowClick) { grid.SelectRow(data); } }) />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Property="@nameof(ApplicationUser.Name)" Title="Név" />
                <RadzenDataGridColumn Property="@nameof(ApplicationUser.UserName)" Title="Email" />
                <RadzenDataGridColumn Property="@nameof(ApplicationUser.Organisation)" Title="Szervezet" />
                <RadzenDataGridColumn Property="@nameof(ApplicationUser.Group)" Title="Csoport" />
            </Columns>
        </RadzenDataGrid>
    </div>

    @if (isProcessing)
    {
        <div class="d-flex flex-column align-items-center justify-content-center" style="height: 200px;">
            <img src="/img/loading.gif" alt="loading" style="width: 50px;" />
        </div>
    }
    else
    {
        <div class="glass-section">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" class="rz-mb-4">
                <RadzenLabel Text="Időszak:" Style="font-weight: 800; color: #233D4D; font-size: 1.2rem;" />
                <RadzenDatePicker @bind-Value="@viewDate" DateFormat="yyyy MMMM" Change="@OnViewDateChanged" ShowTime="false" class="glass-datepicker" />
            </RadzenStack>

            @if (selectedEmployees != null && selectedEmployees.Any())
            {
                <div class="matrix-scroll-container">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th class="sticky-col sticky-header">Név</th>
                                @for (int day = 1; day <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); day++)
                                {
                                    var currentDayDate = new DateTime(viewDate.Year, viewDate.Month, day);
                                    <th class="@(IsWeekend(currentDayDate) ? "weekend-header" : "") sticky-header">
                                        <div class="day-number">@day</div>
                                        <div class="day-name">@currentDayDate.ToString("ddd")</div>
                                    </th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var emp in selectedEmployees)
                            {
                                <tr>
                                    <td class="sticky-col name-cell">
                                        <div class="name-text">@emp.Name</div>
                                    </td>
                                    @for (int day = 1; day <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); day++)
                                    {
                                        var dateToCheck = new DateTime(viewDate.Year, viewDate.Month, day);
                                        var appointment = GetAppointmentForUserAndDate(emp.Id, dateToCheck);
                                        var bgStyle = GetColorForType(appointment?.Type);
                                        var isWeekend = IsWeekend(dateToCheck);

                                        <td class="matrix-cell @(isWeekend ? "weekend-cell" : "")" style="@bgStyle" title="@(appointment?.Type ?? "")">
                                            @if (appointment != null)
                                            {
                                                <span class="event-indicator">@appointment.Type?.FirstOrDefault()</span>
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="glass-alert">
                    <RadzenIcon Icon="info" /> Válassz ki legalább egy felhasználót a fenti listából a táblázat megtekintéséhez!
                </div>
            }
        </div>
    }
</div>

@code {
    private bool isProcessing { get; set; } = true;

    private bool allowRowSelectOnRowClick = true;
    private IEnumerable<ApplicationUser> employees;
    private IList<ApplicationUser>? selectedEmployees;
    private RadzenDataGrid<ApplicationUser> grid;
    private DateTime viewDate = DateTime.Today;

    private RadzenDropDown<IEnumerable<string>> dd;
    private IEnumerable<string> values;
    private IEnumerable<GroupItem> groupedData = new List<GroupItem>();
    private string search;

    private readonly List<OrganizationDef> organizationDefinitions = new List<OrganizationDef>
    {
        new OrganizationDef
        {
            Name = "Infrastruktúra és szolgáltatások",
            Groups = new List<string> { "Webfejlesztés", "Informatika", "Alaprendszer" }
        },
        new OrganizationDef
        {
            Name = "Forrás-termékfejlesztés",
            Groups = new List<string> { "Egyedi fejlesztések", "Pénzügy" }
        },
        new OrganizationDef
        {
            Name = "Projektigazgatóság",
            Groups = new List<string> { "Logisztika" }
        }
    };

    private class GroupItem
    {
        public string Organization { get; set; }
        public string GroupName { get; set; }
        public IEnumerable<string> Children { get; set; } = Enumerable.Empty<string>();
    }

    private class OrganizationDef
    {
        public string Name { get; set; }
        public IEnumerable<string> Groups { get; set; }
    }

    private IEnumerable<MyAppointment> appointments = new List<MyAppointment>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAppointments();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await Populate();
        FilterEmployees();
    }

    private async Task LoadAppointments()
    {
        isProcessing = true;
        if (selectedEmployees != null && selectedEmployees.Any())
        {
            var selectedUserIds = selectedEmployees.Select(u => u.Id).ToList();
            appointments = await _appointmentRepository.GetByUsersAsync(selectedUserIds);
        }
        else
        {
            appointments = new List<MyAppointment>();
        }
        isProcessing = false;
        StateHasChanged();
    }

    private void OnViewDateChanged(DateTime? value)
    {
        if (value.HasValue)
        {
            viewDate = value.Value;
            StateHasChanged();
        }
    }

    private bool IsWeekend(DateTime date)
    {
        return date.DayOfWeek == DayOfWeek.Saturday || date.DayOfWeek == DayOfWeek.Sunday;
    }

    private MyAppointment? GetAppointmentForUserAndDate(string userId, DateTime date)
    {
        if (appointments == null)
        {
            return null;
        }
        return appointments.FirstOrDefault(a =>
            (a.UserId == userId) &&
            a.Start.Date <= date.Date &&
            a.End.Date >= date.Date
        );
    }

    private string GetColorForType(string? type)
    {
        if (string.IsNullOrEmpty(type)) return "";
        return type switch
        {
            "Szabadság" => "background-color: rgba(102, 187, 106, 0.7); box-shadow: inset 0 0 5px rgba(0,0,0,0.1);",
            "HomeOffice" => "background-color: rgba(255, 160, 0, 0.7); box-shadow: inset 0 0 5px rgba(0,0,0,0.1);",
            "Képzés" => "background-color: rgb(239, 83, 80, 0.7); box-shadow: inset 0 0 5px rgba(0,0,0,0.1);",
            "Táppénz" => "background-color: rgba(144, 164, 174, 0.7); box-shadow: inset 0 0 5px rgba(0,0,0,0.1);",
            _ => ""
        };
    }

    private void ItemRender(DropDownItemRenderEventArgs<IEnumerable<string>> args)
    {
        args.Disabled = true;
        var item = (GroupItem)args.Item;
        args.Attributes.Add("style", $"opacity:1;{(item.Organization == null ? "margin-inline-start:1rem" : "")}");
    }

    private async Task Populate()
    {
        var filteredDefs = organizationDefinitions.Select(org => new OrganizationDef
        {
            Name = org.Name,
            Groups = string.IsNullOrEmpty(search) ? org.Groups :
                     org.Groups.Where(g => g.ToLower().Contains(search.ToLower()) || org.Name.ToLower().Contains(search.ToLower())).ToList()
        }).Where(org => org.Groups.Any()).ToList();

        groupedData = await Task.FromResult(filteredDefs
            .SelectMany(org =>
                new GroupItem[] { new GroupItem { Organization = org.Name, Children = org.Groups } }
                .Concat(org.Groups.Select(g => new GroupItem { GroupName = g }))
            ).ToList());
    }

    private bool? AreAllSelected()
    {
        var allDataItems = groupedData.Where(x => x.Organization == null).ToList();
        if (!allDataItems.Any()) return false;
        var selectedCount = allDataItems.Count(g => values?.Contains(g.GroupName) == true);
        return selectedCount == allDataItems.Count ? true : selectedCount > 0 ? null : false;
    }

    private bool? IsGroupSelected(GroupItem item)
    {
        if (item.Organization != null)
        {
            if (!item.Children.Any()) return false;
            var selectedChildren = item.Children.Count(childName => values?.Contains(childName) == true);
            return selectedChildren == item.Children.Count() ? true : selectedChildren > 0 ? null : false;
        }
        return values?.Contains(item.GroupName) == true;
    }

    private void SelectGroup(bool? value, GroupItem item)
    {
        var currentValues = (values ?? Enumerable.Empty<string>()).ToList();
        IEnumerable<string> itemsToToggle;
        if (item.Organization != null) itemsToToggle = item.Children;
        else itemsToToggle = new[] { item.GroupName };

        if (value == true)
        {
            foreach (var g in itemsToToggle) if (!currentValues.Contains(g)) currentValues.Add(g);
        }
        else
        {
            foreach (var g in itemsToToggle) currentValues.Remove(g);
        }
        values = currentValues;
        FilterEmployees();
    }

    private void SelectAll(bool? value)
    {
        values = value == true ? groupedData.Where(x => x.Organization == null).Select(x => x.GroupName).ToList() : Enumerable.Empty<string>();
        FilterEmployees();
    }

    private void FilterEmployees()
    {
        if (values == null || !values.Any()) employees = UserManager.Users.ToList();
        else employees = UserManager.Users.Where(u => values.Contains(u.Group)).ToList();
        selectedEmployees = null;
        StateHasChanged();
    }

    private async Task Search(ChangeEventArgs args)
    {
        search = $"{args.Value}";
        await Populate();
    }
}