@page "/sharedcalendar"

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Radzen
@using Microsoft.EntityFrameworkCore
@using CalendarWebApp.Repository.IRepository
@using MyAppointment = RadzenBlazorDemos.Appointment
@using CalendarWebApp.Data
@attribute [Authorize]

@inject DialogService DialogService
@inject IAppointmentRepository _appointmentRepository
@inject Radzen.TooltipService TooltipService
@inject AuthenticationStateProvider _AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager


<RadzenCard Variant="Variant.Outlined" class="rz-my-4">
    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
        <RadzenCheckBox @bind-Value=@allowRowSelectOnRowClick Name="CheckBox1" />
        <RadzenLabel Text="Allow row select on row click" Component="CheckBox1" />
        <RadzenButton Text="Clear selected rows" Click="@(async args => { selectedEmployees = null; await LoadAppointments(); })" />
    </RadzenStack>
</RadzenCard>

<RadzenDataGrid @ref="grid" AllowRowSelectOnRowClick="true" AllowFiltering="true" FilterPopupRenderMode="PopupRenderMode.OnDemand" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowPaging="true" PageSize="4"
                AllowSorting="true" Data="@employees" ColumnWidth="200px"
                SelectionMode="DataGridSelectionMode.Multiple"
                Value="@selectedEmployees"
                ValueChanged="@(async (IList<ApplicationUser> args) => { selectedEmployees = args; await LoadAppointments(); })">
    <Columns>
        <RadzenDataGridColumn Width="60px" Sortable="false" Filterable="false">
            <HeaderTemplate>
                <RadzenCheckBox TabIndex="-1" TriState="false" TValue="bool?" InputAttributes="@(new Dictionary<string, object>() { { "aria-label", "Select all items" } })"
                                Value="@(selectedEmployees == null || selectedEmployees?.Any() != true ? false : !employees.All(i => selectedEmployees.Contains(i)) ? null : employees.Any(i => selectedEmployees.Contains(i)))"
                                Change="@(async args => {
                                    selectedEmployees = args == true ? employees.ToList() : null;
                                    await LoadAppointments();
                                })" />
            </HeaderTemplate>
            <Template Context="data">
                <RadzenCheckBox TabIndex="-1" TriState="false" Value="@(selectedEmployees != null && selectedEmployees.Contains(data))" InputAttributes="@(new Dictionary<string, object>() { { "aria-label", "Select item" } })"
                                TValue="bool" Change=@(args => { if (!allowRowSelectOnRowClick) { grid.SelectRow(data); } }) />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.UserName)" Title="Email" />
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.PhoneNumber)" Title="Phone number" />
        <RadzenDataGridColumn Property="@nameof(ApplicationUser.DateOfBirth)" Title="Date of birth" FormatString="{0:d}" />
    </Columns>
</RadzenDataGrid>


@if (IsProcessing)
{
    <div class="position-absolute w-75 h-75 d-flex flex-column align-items-center bg-white justify-content-center">
        <img src="/img/loading.gif" alt="loading" />
    </div>
}
else
{
    <RadzenScheduler @ref=@scheduler SlotRender=@OnSlotRender style="height: 768px;" TItem="MyAppointment" Data=@appointments StartProperty="Start" EndProperty="End" ShowHeader=true
                     TextProperty="Text" SelectedIndex="2" AppointmentMouseEnter=@OnAppointmentMouseEnter AppointmentMouseLeave=@OnAppointmentMouseLeave
                     AppointmentRender=@OnAppointmentRender DaySelect="@OnDaySelect">
        <RadzenDayView />
        <RadzenWeekView />
        <RadzenMonthView />
    </RadzenScheduler>

    @* <EventConsole @ref=@console /> *@   
}

@code {
    RadzenScheduler<MyAppointment> scheduler;
    // EventConsole console;
    Dictionary<DateTime, string> events = new Dictionary<DateTime, string>();
    private bool IsProcessing { get; set; } = true;

    bool allowRowSelectOnRowClick = true;
    IEnumerable<ApplicationUser> employees;
    IList<ApplicationUser>? selectedEmployees;
    RadzenDataGrid<ApplicationUser> grid;

    IEnumerable<MyAppointment> appointments = new List<MyAppointment>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAppointments();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        employees = UserManager.Users.ToList();
    }

    private async Task LoadAppointments()
    {
        IsProcessing = true;
        if (selectedEmployees != null && selectedEmployees.Any())
        {
            var selectedUserIds = selectedEmployees.Select(u => u.Id).ToList();
            appointments = await _appointmentRepository.GetByUsersAsync(selectedUserIds);
        }
        else
        {
            appointments = new List<MyAppointment>();
        }

        if (scheduler != null)
        {
            await scheduler.Reload();
        }
        IsProcessing = false;
        StateHasChanged();
    }

    void OnDaySelect(SchedulerDaySelectEventArgs args)
    {
        // console.Log($"DaySelect: Day={args.Day} AppointmentCount={args.Appointments.Count()}");
    }

    void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        // Highlight today in month view
        if (args.View.Text == "Month" && args.Start.Date == DateTime.Today)
        {
            args.Attributes["style"] = "background: var(--rz-scheduler-highlight-background-color, rgba(255,220,40,.2));";
        }

        // Highlight working hours (8-17)
        if ((args.View.Text == "Week" || args.View.Text == "Day") && args.Start.Hour > 7 && args.Start.Hour < 18)
        {
            args.Attributes["style"] = "background: var(--rz-scheduler-highlight-background-color, rgba(255,220,40,.2));";
        }

        // Color the slot depending on number of appointments for that day
        if (args.Appointments.Count() > 4)
        {
            args.Attributes["style"] = "background: #ffabab;";
        }
        else if (args.Appointments.Count() > 2)
        {
            args.Attributes["style"] = "background: #ffc988;";
        }
        else if (args.Appointments.Count() > 0)
        {
            args.Attributes["style"] = "background: #c3ffc3;";
        }
    }

    void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<MyAppointment> args)
    {
        // Never call StateHasChanged in AppointmentRender - would lead to infinite loop

        switch (args.Data.Type)
        {
            case "Szabadság":
                args.Attributes["style"] = "background: #66BB6A";
                break;
            case "HomeOffice":
                args.Attributes["style"] = "background: #FFA000";
                break;
            case "Képzés":
                args.Attributes["style"] = "background: #EF5350";
                break;
        }

    }

    // Improved tooltip: render HTML when present, preserve newlines for plain text, limit height and allow scrolling
    void OnAppointmentMouseEnter(SchedulerAppointmentMouseEventArgs<Appointment> args)
    {
        static bool IsSingleDay(Appointment a)
        {
            var startDate = a.Start.Date;
            var effectiveEndDate = a.End.TimeOfDay == TimeSpan.Zero ? a.End.Date.AddDays(-1) : a.End.Date;
            return startDate == effectiveEndDate;
        }

        bool onlySunday = IsSingleDay(args.Data) && args.Data.Start.DayOfWeek == DayOfWeek.Sunday;
        var position = onlySunday ? TooltipPosition.Left : TooltipPosition.Top;

        TooltipService.Open(args.Element, ts =>
        @<RadzenStack Orientation="Orientation.Vertical" Gap="0" class="rz-p-6" Style="min-width: 250px; max-width: 500px;">
            <RadzenText TextStyle="TextStyle.H4" class="rz-mb-4" Style="color: var(--rz-tooltip-color);">
                @args.Data.Text
            </RadzenText>
            @if (args.Data.Type != null)
            {
                <RadzenStack Orientation="Orientation.Horizontal" Gap="4px">
                    <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color); width: 44px;">
                        <strong>Type</strong>
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color);">
                        @args.Data.Type
                    </RadzenText>
                </RadzenStack>
            }
            <RadzenStack Orientation="Orientation.Horizontal" Gap="4px">
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color); width: 44px;">
                    <strong>Start</strong>
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color);">
                    @args.Data.Start.ToString("hh:mm ⋅ dddd, MMMM d")
                </RadzenText>
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="4px">
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color); width: 44px;">
                    <strong>End</strong>
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-tooltip-color);">
                    @args.Data.End.ToString("hh:mm ⋅ dddd, MMMM d")
                </RadzenText>
            </RadzenStack>

            @if (args.Data.Description != null)
            {
                <RadzenStack Orientation="Orientation.Vertical" Style="align-items:flex-start; margin-top: 8px;">
                    <RadzenText TextStyle="TextStyle.Body1" Style="color: var(--rz-tooltip-color); width: 64px;">
                        <strong>Description</strong>
                    </RadzenText>
                    <div style="max-height:150px; overflow:auto; white-space:pre-wrap; word-break:break-word; color: var(--rz-tooltip-color); font-size:0.95rem;">
                        @FormatDescription(args.Data.Description)
                    </div>
                </RadzenStack>
            }
        </RadzenStack>, new TooltipOptions { Position = position, Duration = null });
    }

    void OnAppointmentMouseLeave(SchedulerAppointmentMouseEventArgs<Appointment> args)
    {
        TooltipService.Close();
    }

    private static MarkupString FormatDescription(string? description)
    {
        if (string.IsNullOrWhiteSpace(description))
        {
            return new MarkupString(string.Empty);
        }

        var trimmed = description!.Trim();

        if (trimmed.Contains("<") && trimmed.Contains(">"))
        {
            return new MarkupString(trimmed);
        }

        var encoded = System.Text.Encodings.Web.HtmlEncoder.Default.Encode(trimmed)
            .Replace("\r\n", "<br/>")
            .Replace("\n", "<br/>");
        return new MarkupString(encoded);
    }
}